<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Render Order Theta - Debug Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .main-content {
            padding: 30px;
        }

        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .step.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .step.completed {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .step.error {
            border-color: #e74c3c;
            background: #fdf2f2;
        }

        .step h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 600;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .result pre {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 200px;
        }

        .hidden {
            display: none;
        }

        .uuid-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }

        .debug-info h5 {
            color: #495057;
            margin-bottom: 10px;
        }

        .debug-info pre {
            background: #e9ecef;
            padding: 10px;
            border-radius: 3px;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }

        .step-indicator .step-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            position: relative;
        }

        .step-indicator .step-dot.active {
            background: #667eea;
            color: white;
        }

        .step-indicator .step-dot.completed {
            background: #27ae60;
            color: white;
        }

        .step-indicator .step-dot.error {
            background: #e74c3c;
            color: white;
        }

        .step-indicator .step-dot:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 80px;
            height: 2px;
            background: #e0e0e0;
            transform: translateY(-50%);
        }

        .step-indicator .step-dot.completed:not(:last-child)::after {
            background: #27ae60;
        }

        .step-indicator .step-dot.error:not(:last-child)::after {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Video Render Order Theta - Debug Interface</h1>
            <p>Giao di·ªán debug chi ti·∫øt ƒë·ªÉ ki·ªÉm tra t·ª´ng b∆∞·ªõc</p>
        </div>

        <div class="main-content">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-dot active" id="step1-dot">1</div>
                <div class="step-dot" id="step2-dot">2</div>
                <div class="step-dot" id="step3-dot">3</div>
                <div class="step-dot" id="step4-dot">4</div>
                <div class="step-dot" id="step5-dot">5</div>
                <div class="step-dot" id="step6-dot">6</div>
                <div class="step-dot" id="step7-dot">7</div>
                <div class="step-dot" id="step8-dot">8</div>
            </div>

            <!-- Step 1: Create Order -->
            <div class="step active" id="step1">
                <h3>üìù B∆∞·ªõc 1: T·∫°o Order t·ª´ YouTube</h3>
                <div class="form-group">
                    <label for="youtube-url">URL YouTube:</label>
                    <input type="url" id="youtube-url" placeholder="https://www.youtube.com/watch?v=..." value="https://www.youtube.com/watch?v=H45Ky-SsCGU">
                </div>
                <div class="form-group">
                    <label for="order-content">N·ªôi dung Order:</label>
                    <textarea id="order-content" placeholder="M√¥ t·∫£ n·ªôi dung b·∫°n mu·ªën t·∫°o...">Keyword: Phi t·∫ßn nam Ottman ƒë√£ t·ª´ng tr·∫£i qua nh·ªØng ƒëi·ªÅu kinh ho√†ng n√†o. Follow √Ω t∆∞·ªüng n·ªôi dung Video tham kh·∫£o -> tri·ªÉn khai d√†n √Ω nh∆∞ c√°c video c≈© tr√™n k√™nh - B·ªë c·ª•c t∆∞∆°ng t·ª± video g·ªëc: Gia tƒÉng th√™m y·∫øu t·ªë ch√†ng trai ph√≠a tr∆∞·ªõc b·ªã b·∫Øt n·∫°t, ƒë√°ng s·ª£. Nh√¢n v·∫≠t nam ph√≠a sau c∆∞·ªùi nham hi·ªÉu. Phong c√°i thi·∫øt k·∫ø th·ªùi ottoman</textarea>
                </div>
                <button class="btn" onclick="createOrder()">T·∫°o Order</button>
                <div id="order-status" class="hidden"></div>
                <div id="order-result" class="hidden"></div>
            </div>

            <!-- Step 2: Wait for Order Completion -->
            <div class="step" id="step2">
                <h3>‚è≥ B∆∞·ªõc 2: Ch·ªù Order Ho√†n Th√†nh</h3>
                <div class="form-group">
                    <label for="check-uuid">UUID ƒë·ªÉ ki·ªÉm tra:</label>
                    <input type="text" id="check-uuid" placeholder="UUID s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông" readonly>
                </div>
                <button class="btn" onclick="waitForOrderCompletion()" id="wait-btn" disabled>Ch·ªù Order Ho√†n Th√†nh</button>
                <div id="wait-status" class="hidden"></div>
                <div id="wait-result" class="hidden"></div>
            </div>

            <!-- Step 3: Generate Audio -->
            <div class="step" id="step3">
                <h3>üéµ B∆∞·ªõc 3: T·∫°o Audio</h3>
                <div class="form-group">
                    <label for="audio-uuid">UUID t·ª´ b∆∞·ªõc 1:</label>
                    <input type="text" id="audio-uuid" placeholder="UUID s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông" readonly>
                </div>
                <button class="btn" onclick="generateAudio()" id="audio-btn" disabled>T·∫°o Audio</button>
                <div id="audio-status" class="hidden"></div>
                <div id="audio-result" class="hidden"></div>
            </div>

            <!-- Step 4: Check Audio Status -->
            <div class="step" id="step4">
                <h3>üîç B∆∞·ªõc 4: Ki·ªÉm tra Audio Status</h3>
                <div class="form-group">
                    <label for="audio-check-uuid">UUID ƒë·ªÉ ki·ªÉm tra audio:</label>
                    <input type="text" id="audio-check-uuid" placeholder="UUID s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông" readonly>
                </div>
                <button class="btn" onclick="checkAudioStatus()" id="audio-check-btn" disabled>Ki·ªÉm tra Audio</button>
                <div id="audio-check-status" class="hidden"></div>
                <div id="audio-check-result" class="hidden"></div>
            </div>

            <!-- Step 5: Generate Images -->
            <div class="step" id="step5">
                <h3>üñºÔ∏è B∆∞·ªõc 5: T·∫°o H√¨nh ·∫¢nh</h3>
                <div class="form-group">
                    <label for="image-uuid">UUID t·ª´ b∆∞·ªõc 1:</label>
                    <input type="text" id="image-uuid" placeholder="UUID s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông" readonly>
                </div>
                <div class="form-group">
                    <label for="image-count">S·ªë l∆∞·ª£ng h√¨nh ·∫£nh:</label>
                    <select id="image-count">
                        <option value="5">5 h√¨nh</option>
                        <option value="10" selected>10 h√¨nh</option>
                        <option value="15">15 h√¨nh</option>
                        <option value="20">20 h√¨nh</option>
                    </select>
                </div>
                <button class="btn" onclick="generateImages()" id="image-btn" disabled>T·∫°o H√¨nh ·∫¢nh</button>
                <div id="image-status" class="hidden"></div>
                <div id="image-result" class="hidden"></div>
            </div>


            <!-- Step 6: Check Image Status -->
            <div class="step" id="step6">
                <h3>üîç B∆∞·ªõc 6: Ki·ªÉm tra H√¨nh ·∫¢nh Status</h3>
                <div class="form-group">
                    <label for="image-check-uuid">UUID ƒë·ªÉ ki·ªÉm tra h√¨nh ·∫£nh:</label>
                    <input type="text" id="image-check-uuid" placeholder="Nh·∫≠p UUID ƒë·ªÉ ki·ªÉm tra h√¨nh ·∫£nh">
                </div>
                <button class="btn" onclick="useCurrentUUIDForImageCheck()" id="use-current-for-check-btn" disabled>D√πng UUID hi·ªán t·∫°i</button>
                <button class="btn" onclick="checkImageStatus()" id="image-check-btn">Ki·ªÉm tra H√¨nh ·∫¢nh</button>
                <div id="image-check-status" class="hidden"></div>
                <div id="image-check-result" class="hidden"></div>
            </div>

            <!-- Step 7: Render Video -->
            <div class="step" id="step7">
                <h3>üé¨ B∆∞·ªõc 7: Render Video</h3>
                <div class="form-group">
                    <label for="video-uuid">UUID t·ª´ b∆∞·ªõc 1:</label>
                    <input type="text" id="video-uuid" placeholder="UUID s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông">
                </div>
                <div class="form-group">
                    <label for="video-id">ID (t√πy ch·ªçn):</label>
                    <input type="number" id="video-id" placeholder="Nh·∫≠p ID n·∫øu c√≥">
                </div>
                <button class="btn" onclick="enableVideoRender()" id="enable-video-btn">Enable Render Video</button>
                <button class="btn" onclick="renderVideo()" id="video-btn" disabled>Render Video</button>
                <div id="video-status" class="hidden"></div>
                <div id="video-result" class="hidden"></div>
            </div>

            <!-- Step 8: Check Video Status -->
            <div class="step" id="step8">
                <h3>üîç B∆∞·ªõc 8: Ki·ªÉm tra Video Status</h3>
                <div class="form-group">
                    <label for="video-check-uuid">UUID ƒë·ªÉ ki·ªÉm tra video:</label>
                    <input type="text" id="video-check-uuid" placeholder="UUID s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông">
                </div>
                <button class="btn" onclick="enableVideoCheck()" id="enable-video-check-btn">Enable Check Video</button>
                <button class="btn" onclick="checkVideoStatus()" id="video-check-btn" disabled>Ki·ªÉm tra Video</button>
                <div id="video-check-status" class="hidden"></div>
                <div id="video-check-result" class="hidden"></div>
            </div>

            <!-- Current UUID Display -->
            <div class="debug-info">
                <h5>üÜî Current UUID Information</h5>
                <div id="current-uuid-info">
                    <p><strong>Current UUID:</strong> <span id="current-uuid-display">Ch∆∞a c√≥</span></p>
                    <p><strong>Order Status:</strong> <span id="current-order-status">Ch∆∞a c√≥</span></p>
                    <p><strong>Audio Status:</strong> <span id="current-audio-status">Ch∆∞a c√≥</span></p>
                    <button class="btn" onclick="copyCurrentUUID()" id="copy-uuid-btn" disabled>Copy UUID</button>
                    <button class="btn" onclick="useCurrentUUIDForQuickImage()" id="use-current-uuid-btn" disabled>D√πng UUID n√†y t·∫°o h√¨nh ·∫£nh</button>
                </div>
            </div>

            <!-- Debug Information -->
            <div class="debug-info">
                <h5>üêõ Debug Information</h5>
                <div id="debug-log">
                    <p>Ch∆∞a c√≥ th√¥ng tin debug...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUUID = null;
        let orderData = null;
        let orderCompleted = false;
        let audioCompleted = false;
        let imagesCompleted = false;
        let videoCompleted = false;

        // API Base URL
        const API_BASE = window.location.origin + '/api/v1/tasks';

        // Debug logging
        function debugLog(message, data = null) {
            const debugDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                logEntry += `\nData: ${JSON.stringify(data, null, 2)}`;
            }
            
            debugDiv.innerHTML = `<pre>${logEntry}</pre>` + debugDiv.innerHTML;
        }

        // Update current UUID info
        function updateCurrentUUIDInfo() {
            document.getElementById('current-uuid-display').textContent = currentUUID || 'Ch∆∞a c√≥';
            document.getElementById('current-order-status').textContent = orderCompleted ? 'Ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
            document.getElementById('current-audio-status').textContent = audioCompleted ? 'Ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
            
            // Enable/disable buttons based on UUID availability
            const hasUUID = currentUUID && currentUUID !== 'Ch∆∞a c√≥';
            document.getElementById('copy-uuid-btn').disabled = !hasUUID;
            document.getElementById('use-current-uuid-btn').disabled = !hasUUID;
            document.getElementById('use-current-for-check-btn').disabled = !hasUUID;
        }

        // Copy current UUID to clipboard
        function copyCurrentUUID() {
            if (currentUUID) {
                navigator.clipboard.writeText(currentUUID).then(() => {
                    alert('UUID ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard!');
                }).catch(err => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = currentUUID;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('UUID ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard!');
                });
            }
        }

        // Use current UUID for quick image generation
        function useCurrentUUIDForQuickImage() {
            if (currentUUID) {
                document.getElementById('quick-uuid').value = currentUUID;
                // Scroll to quick image section
                document.getElementById('quick-image-step').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Use current UUID for image check
        function useCurrentUUIDForImageCheck() {
            if (currentUUID) {
                document.getElementById('image-check-uuid').value = currentUUID;
                // Scroll to image check section
                document.getElementById('step6').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Utility functions
        function showStatus(elementId, message, type = 'processing') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function showResult(elementId, content) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.classList.remove('hidden');
        }

        function updateStepIndicator(activeStep, errorStep = null) {
            for (let i = 1; i <= 8; i++) {
                const dot = document.getElementById(`step${i}-dot`);
                const step = document.getElementById(`step${i}`);
                
                if (i === errorStep) {
                    dot.classList.add('error');
                    dot.classList.remove('active', 'completed');
                    step.classList.add('error');
                    step.classList.remove('active', 'completed');
                } else if (i < activeStep) {
                    dot.classList.add('completed');
                    dot.classList.remove('active', 'error');
                    step.classList.add('completed');
                    step.classList.remove('active', 'error');
                } else if (i === activeStep) {
                    dot.classList.add('active');
                    dot.classList.remove('completed', 'error');
                    step.classList.add('active');
                    step.classList.remove('completed', 'error');
                } else {
                    dot.classList.remove('active', 'completed', 'error');
                    step.classList.remove('active', 'completed', 'error');
                }
            }
        }

        // Step 1: Create Order
        async function createOrder() {
            const url = document.getElementById('youtube-url').value;
            const order = document.getElementById('order-content').value;

            if (!url) {
                alert('Vui l√≤ng nh·∫≠p URL YouTube');
                return;
            }

            showStatus('order-status', 'ƒêang t·∫°o order...', 'processing');
            updateStepIndicator(1);
            debugLog('Creating order...', { url, order });

            try {
                const requestBody = {
                    url: url,
                    order: order,
                    platform: 'youtube',
                    language: 'en',
                    task: 'Gemini',
                    length: 10000
                };

                debugLog('Sending request to /create', requestBody);

                const response = await fetch(`${API_BASE}/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': navigator.userAgent
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                debugLog('Received response from /create', { status: response.status, data });

                if (response.ok) {
                    currentUUID = data.uuid;
                    document.getElementById('check-uuid').value = currentUUID;
                    document.getElementById('audio-uuid').value = currentUUID;
                    document.getElementById('audio-check-uuid').value = currentUUID;
                    document.getElementById('image-uuid').value = currentUUID;
                    document.getElementById('image-check-uuid').value = currentUUID;
                    document.getElementById('video-uuid').value = currentUUID;
                    document.getElementById('video-check-uuid').value = currentUUID;
                    updateCurrentUUIDInfo();

                    showStatus('order-status', 'Order ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'completed');
                    showResult('order-result', `
                        <h4>‚úÖ Order Created Successfully</h4>
                        <div class="uuid-display">UUID: ${currentUUID}</div>
                        <p>Order ƒë√£ ƒë∆∞·ª£c t·∫°o v√† ƒëang x·ª≠ l√Ω trong background.</p>
                        <p><strong>L∆∞u √Ω:</strong> Order c·∫ßn th·ªùi gian ƒë·ªÉ x·ª≠ l√Ω. H√£y ch·ªù cho ƒë·∫øn khi status = "done".</p>
                    `);

                    // Enable next step
                    document.getElementById('wait-btn').disabled = false;
                    updateStepIndicator(2);
                } else {
                    throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra');
                }
            } catch (error) {
                debugLog('Error creating order', error.message);
                showStatus('order-status', `L·ªói: ${error.message}`, 'error');
                updateStepIndicator(1, 1);
            }
        }

        // Step 2: Wait for Order Completion
        async function waitForOrderCompletion() {
            if (!currentUUID) {
                alert('Vui l√≤ng t·∫°o order tr∆∞·ªõc');
                return;
            }

            showStatus('wait-status', 'ƒêang ki·ªÉm tra order...', 'processing');
            debugLog('Waiting for order completion...', { uuid: currentUUID });

            const checkInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/create/get?uuid=${currentUUID}`);
                    const data = await response.json();
                    debugLog('Order status check', { status: response.status, data });

                    if (response.ok) {
                        orderData = data;
                        showStatus('wait-status', `Order status: ${data.status}`, 'processing');
                        
                        if (data.status === 'done') {
                            clearInterval(checkInterval);
                            orderCompleted = true;
                            updateCurrentUUIDInfo();
                            showStatus('wait-status', 'Order ƒë√£ ho√†n th√†nh!', 'completed');
                            showResult('wait-result', `
                                <h4>‚úÖ Order Completed</h4>
                                <div class="debug-info">
                                    <h5>Order Data:</h5>
                                    <pre>${JSON.stringify(data, null, 2)}</pre>
                                </div>
                                <p><strong>Status:</strong> ${data.status}</p>
                                <p><strong>Content Order:</strong> ${data.content_order ? 'Available' : 'Not available'}</p>
                            `);

                            // Enable next step
                            document.getElementById('audio-btn').disabled = false;
                            updateStepIndicator(3);
                        } else if (data.status === 'error') {
                            clearInterval(checkInterval);
                            showStatus('wait-status', 'Order failed!', 'error');
                            updateStepIndicator(2, 2);
                        }
                    } else {
                        throw new Error(data.error || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin order');
                    }
                } catch (error) {
                    clearInterval(checkInterval);
                    debugLog('Error checking order status', error.message);
                    showStatus('wait-status', `L·ªói: ${error.message}`, 'error');
                    updateStepIndicator(2, 2);
                }
            }, 3000); // Check every 3 seconds
        }

        // Step 3: Generate Audio
        async function generateAudio() {
            if (!currentUUID || !orderCompleted) {
                alert('Vui l√≤ng ch·ªù order ho√†n th√†nh tr∆∞·ªõc');
                return;
            }

            showStatus('audio-status', 'ƒêang t·∫°o audio...', 'processing');
            updateStepIndicator(3);
            debugLog('Generating audio...', { uuid: currentUUID });

            try {
                const requestBody = {
                    uuid: currentUUID,
                    use_script: false
                };

                debugLog('Sending audio request', requestBody);

                const response = await fetch(`${API_BASE}/audio`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': navigator.userAgent
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                debugLog('Received audio response', { status: response.status, data });

                if (response.ok) {
                    showStatus('audio-status', 'Audio request sent!', 'completed');
                    showResult('audio-result', `
                        <h4>‚úÖ Audio Request Sent</h4>
                        <div class="debug-info">
                            <h5>Response Data:</h5>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                        <p>Audio ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω trong background.</p>
                    `);

                    // Enable next step
                    document.getElementById('audio-check-btn').disabled = false;
                    updateStepIndicator(4);
                } else {
                    throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫°o audio');
                }
            } catch (error) {
                debugLog('Error generating audio', error.message);
                showStatus('audio-status', `L·ªói: ${error.message}`, 'error');
                updateStepIndicator(3, 3);
            }
        }

        // Step 4: Check Audio Status
        async function checkAudioStatus() {
            if (!currentUUID) {
                alert('Vui l√≤ng t·∫°o order tr∆∞·ªõc');
                return;
            }

            showStatus('audio-check-status', 'ƒêang ki·ªÉm tra audio...', 'processing');
            debugLog('Checking audio status...', { uuid: currentUUID });

            try {
                const response = await fetch(`${API_BASE}/audio/get?uuid=${currentUUID}`);
                const data = await response.json();
                debugLog('Received audio status', { status: response.status, data });

                if (response.ok) {
                    audioCompleted = true;
                    updateCurrentUUIDInfo();
                    showStatus('audio-check-status', 'Audio status retrieved!', 'completed');
                    showResult('audio-check-result', `
                        <h4>üéµ Audio Status</h4>
                        <div class="debug-info">
                            <h5>Audio Data:</h5>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <p><strong>Audio Path:</strong> ${data.audio_path || 'Not available'}</p>
                        ${data.audio_path ? `<p><a href="${data.audio_path}" target="_blank">Nghe Audio</a></p>` : ''}
                    `);

                    // Enable next step
                    document.getElementById('image-btn').disabled = false;
                    updateStepIndicator(5);
                } else {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin audio');
                }
            } catch (error) {
                debugLog('Error checking audio status', error.message);
                showStatus('audio-check-status', `L·ªói: ${error.message}`, 'error');
                updateStepIndicator(4, 4);
            }
        }

        // Step 5: Generate Images
        async function generateImages() {
            if (!currentUUID || !orderCompleted) {
                alert('Vui l√≤ng ch·ªù order ho√†n th√†nh tr∆∞·ªõc');
                return;
            }

            const imageCount = document.getElementById('image-count').value;
            showStatus('image-status', 'ƒêang t·∫°o h√¨nh ·∫£nh...', 'processing');
            updateStepIndicator(5);
            debugLog('Generating images...', { uuid: currentUUID, count: imageCount });

            try {
                const requestBody = {
                    uuid: currentUUID,
                    use_script: false
                };

                debugLog('Sending image request', requestBody);

                const response = await fetch(`${API_BASE}/imagen`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': navigator.userAgent
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                debugLog('Received image response', { status: response.status, data });

                if (response.ok) {
                    showStatus('image-status', 'Image request sent!', 'completed');
                    showResult('image-result', `
                        <h4>üñºÔ∏è Image Request Sent</h4>
                        <div class="debug-info">
                            <h5>Response Data:</h5>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                        <p>H√¨nh ·∫£nh ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω trong background.</p>
                        <p><strong>L∆∞u √Ω:</strong> S·ªë l∆∞·ª£ng h√¨nh ·∫£nh s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o d·ª±a tr√™n n·ªôi dung script.</p>
                    `);

                    // Enable next step
                    updateStepIndicator(6);
                } else {
                    throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫°o h√¨nh ·∫£nh');
                }
            } catch (error) {
                debugLog('Error generating images', error.message);
                showStatus('image-status', `L·ªói: ${error.message}`, 'error');
                updateStepIndicator(5, 5);
            }
        }

        // Step 6: Check Image Status
        async function checkImageStatus() {
            const uuid = document.getElementById('image-check-uuid').value.trim();
            
            if (!uuid) {
                alert('Vui l√≤ng nh·∫≠p UUID ƒë·ªÉ ki·ªÉm tra h√¨nh ·∫£nh');
                return;
            }

            showStatus('image-check-status', 'ƒêang ki·ªÉm tra h√¨nh ·∫£nh...', 'processing');
            debugLog('Checking image status...', { uuid: uuid });

            try {
                const response = await fetch(`${API_BASE}/imagen/get?uuid=${uuid}`);
                const data = await response.json();
                debugLog('Received image status', { status: response.status, data });

                if (response.ok) {
                    imagesCompleted = data.status === 'done';
                    showStatus('image-check-status', 'Image status retrieved!', 'completed');
                    
                    let imageGallery = '';
                    if (data.images_path && data.images_path.length > 0) {
                        imageGallery = `
                            <h5>üñºÔ∏è Generated Images:</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0;">
                                ${data.images_path.map((imageData, index) => {
                                    const path = typeof imageData === 'string' ? imageData : (imageData.path || imageData.url || imageData[Object.keys(imageData)[0]]);
                                    return `
                                        <div style="text-align: center;">
                                            <img src="${path}" alt="Generated Image ${index + 1}" 
                                                 style="width: 100%; height: 150px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd;">
                                            <p style="font-size: 12px; margin: 5px 0;">Scene ${imageData.scene_number || index + 1}</p>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }

                    showResult('image-check-result', `
                        <h4>üñºÔ∏è Image Status</h4>
                        <div class="debug-info">
                            <h5>Image Data:</h5>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <p><strong>Total Images:</strong> ${data.images_path ? data.images_path.length : 0}</p>
                        ${imageGallery}
                    `);

                    // Enable video render if images are completed
                    if (imagesCompleted && audioCompleted) {
                        document.getElementById('video-btn').disabled = false;
                        updateStepIndicator(7);
                    }
                } else {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin h√¨nh ·∫£nh');
                }
            } catch (error) {
                debugLog('Error checking image status', error.message);
                showStatus('image-check-status', `L·ªói: ${error.message}`, 'error');
                updateStepIndicator(6, 6);
            }
        }


        // Enable Video Render
        function enableVideoRender() {
            const videoUuid = document.getElementById('video-uuid').value.trim();
            if (!videoUuid) {
                alert('Vui l√≤ng nh·∫≠p UUID tr∆∞·ªõc');
                return;
            }
            
            document.getElementById('video-btn').disabled = false;
            document.getElementById('enable-video-btn').style.display = 'none';
            showStatus('video-status', 'Ready to render video with UUID: ' + videoUuid, 'completed');
            updateStepIndicator(7);
        }

        // Step 7: Render Video
        async function renderVideo() {
            const videoUuid = document.getElementById('video-uuid').value.trim();
            if (!videoUuid) {
                alert('Vui l√≤ng nh·∫≠p UUID');
                return;
            }

            const videoId = document.getElementById('video-id').value;
            showStatus('video-status', 'ƒêang render video...', 'processing');
            updateStepIndicator(7);
            debugLog('Rendering video...', { uuid: videoUuid, id: videoId });

            try {
                const requestBody = {
                    uuid: videoUuid
                };
                
                if (videoId) {
                    requestBody.id = parseInt(videoId);
                }

                debugLog('Sending video render request', requestBody);

                const response = await fetch(`${API_BASE}/video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': navigator.userAgent
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                debugLog('Received video render response', { status: response.status, data });

                if (response.ok) {
                    showStatus('video-status', 'Video render request sent!', 'completed');
                    showResult('video-result', `
                        <h4>üé¨ Video Render Started</h4>
                        <div class="debug-info">
                            <h5>Response Data:</h5>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                        <p>Video ƒëang ƒë∆∞·ª£c render trong background.</p>
                        <p><strong>L∆∞u √Ω:</strong> Qu√° tr√¨nh render c√≥ th·ªÉ m·∫•t v√†i ph√∫t.</p>
                    `);

                    // Enable next step
                    document.getElementById('video-check-btn').disabled = false;
                    updateStepIndicator(8);
                } else {
                    throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra khi render video');
                }
            } catch (error) {
                debugLog('Error rendering video', error.message);
                showStatus('video-status', `L·ªói: ${error.message}`, 'error');
                updateStepIndicator(7, 7);
            }
        }

        // Enable Video Check
        function enableVideoCheck() {
            const videoCheckUuid = document.getElementById('video-check-uuid').value.trim();
            if (!videoCheckUuid) {
                alert('Vui l√≤ng nh·∫≠p UUID tr∆∞·ªõc');
                return;
            }
            
            document.getElementById('video-check-btn').disabled = false;
            document.getElementById('enable-video-check-btn').style.display = 'none';
            showStatus('video-check-status', 'Ready to check video with UUID: ' + videoCheckUuid, 'completed');
            updateStepIndicator(8);
        }

        // Step 8: Check Video Status
        async function checkVideoStatus() {
            const videoCheckUuid = document.getElementById('video-check-uuid').value.trim();
            if (!videoCheckUuid) {
                alert('Vui l√≤ng nh·∫≠p UUID');
                return;
            }

            showStatus('video-check-status', 'ƒêang ki·ªÉm tra video...', 'processing');
            debugLog('Checking video status...', { uuid: videoCheckUuid });

            try {
                const response = await fetch(`${API_BASE}/video/get?uuid=${videoCheckUuid}`);
                const data = await response.json();
                debugLog('Received video status', { status: response.status, data });

                if (response.ok) {
                    videoCompleted = data.status === 'done';
                    showStatus('video-check-status', 'Video status retrieved!', 'completed');
                    
                    let videoPlayer = '';
                    if (data.video_path && data.status === 'done') {
                        videoPlayer = `
                            <h5>üé¨ Generated Video:</h5>
                            <div style="margin: 10px 0;">
                                <video controls style="width: 100%; max-width: 600px; border-radius: 5px; border: 1px solid #ddd;">
                                    <source src="${data.video_path}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                                <p style="margin: 10px 0;"><a href="${data.video_path}" target="_blank" download>T·∫£i xu·ªëng video</a></p>
                            </div>
                        `;
                    }

                    showResult('video-check-result', `
                        <h4>üé¨ Video Status</h4>
                        <div class="debug-info">
                            <h5>Video Data:</h5>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                        <p><strong>Status:</strong> ${data.status}</p>
                        <p><strong>Video Path:</strong> ${data.video_path || 'Not available'}</p>
                        ${videoPlayer}
                        ${data.status === 'done' ? '<p><strong>‚úÖ Pipeline ho√†n th√†nh!</strong></p>' : '<p><strong>‚è≥ Video ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω...</strong></p>'}
                    `);
                } else {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin video');
                }
            } catch (error) {
                debugLog('Error checking video status', error.message);
                showStatus('video-check-status', `L·ªói: ${error.message}`, 'error');
                updateStepIndicator(8, 8);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStepIndicator(1);
        });
    </script>
</body>
</html>
